# docker build -f .devcontainer/Dockerfile.dev -t uswds-django-dev .
# docker run -p 8000:8000 -v $(pwd):/app uswds-django-dev

# Use an official Python runtime as a parent image
FROM python:3.11-slim

# Create non-root user first (needed for NVM)
RUN useradd -ms /bin/bash vscode

# Set environment variables
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV NVM_DIR=/home/vscode/.nvm
ENV NODE_VERSION=24.11.0

# Set work directory
WORKDIR /app

# Install system dependencies
# Add Microsoft repository and install MSSQL ODBC driver and tools
RUN apt-get update && apt-get install -y \
  curl \
  gnupg2 \
  && mkdir -p /etc/apt/keyrings \
  && curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor -o /etc/apt/keyrings/microsoft.gpg \
  && echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/microsoft.gpg] https://packages.microsoft.com/debian/11/prod bullseye main" > /etc/apt/sources.list.d/mssql-release.list \
  && apt-get update

# No need for NODE_PATH and PATH here as we're using NVM properly now

# Install development tools and utilities
RUN ACCEPT_EULA=Y apt-get install -y \
  build-essential \
  git \
  vim \
  ssh \
  default-mysql-client \
  postgresql-client \
  sqlite3 \
  unixodbc \
  unixodbc-dev \
  msodbcsql18 \
  mssql-tools18 \
  && rm -rf /var/lib/apt/lists/*

# Add SQL Server tools to PATH
ENV PATH="$PATH:/opt/mssql-tools18/bin"

# Set ownership
RUN chown -R vscode:vscode /app

# Switch to vscode user for NVM installation
USER vscode

# Install NVM and Node.js
RUN curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash \
    && . $NVM_DIR/nvm.sh \
    && nvm install $NODE_VERSION \
    && nvm alias default $NODE_VERSION \
    && nvm use default

# Add NVM to bash profile
RUN echo 'export NVM_DIR="$HOME/.nvm"' >> ~/.bashrc \
    && echo '[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"' >> ~/.bashrc \
    && echo '[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"' >> ~/.bashrc

# Copy dependency files first for better caching
COPY --chown=vscode:vscode package*.json requirements.txt ./

# Install dependencies (reload NVM in this session)
RUN . $NVM_DIR/nvm.sh \
    && pip install --no-cache-dir -r requirements.txt \
    && npm install

# Copy project files
COPY --chown=vscode:vscode . .

# Build the project
RUN . $NVM_DIR/nvm.sh \
    && npm run build

RUN python server/manage.py migrate

# Expose the development server port
EXPOSE 8000

# Command to run the development server
CMD ["python", "server/manage.py", "runserver", "0.0.0.0:8000"]
